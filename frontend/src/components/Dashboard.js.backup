import React, { useState, useEffect, useContext } from 'react';
import { AuthContext } from '../contexts/AuthContext';
import { assessmentService } from '../services';
import './Dashboard.css';

const Dashboard = () => {
    const { user } = useContext(AuthContext);
    const [assessments, setAssessments] = useState([]);
    const [dashboardData, setDashboardData] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        fetchDashboardData();
    }, []);

    const fetchDashboardData = async () => {
        try {
            const [assessmentsData, dashboardData] = await Promise.all([
                assessmentService.getAssessments(),
                assessmentService.getDashboardData()
            ]);
            
            setAssessments(assessmentsData);
            setDashboardData(dashboardData);
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleTakeAssessment = (assessmentId) => {
        // Navigate to assessment taking interface
        window.alert(\Starting assessment: \\nThis will open the assessment interface in the next step.\);
    };

    const handleCreateNewAssessment = async () => {
        try {
            const newAssessment = {
                title: 'New HVI Assessment',
                description: 'Assessment created from dashboard',
                department: user?.department || 'General',
                questions: []
            };
            
            const createdAssessment = await assessmentService.createAssessment(newAssessment);
            setAssessments(prev => [createdAssessment, ...prev]);
            window.alert('New assessment created successfully!');
        } catch (error) {
            console.error('Error creating assessment:', error);
            window.alert('Error creating assessment. Please try again.');
        }
    };

    if (loading) {
        return (
            <div className="dashboard-loading">
                <div className="loading-spinner"></div>
                <p>Loading dashboard...</p>
            </div>
        );
    }

    return (
        <div className="dashboard">
            <div className="dashboard-header">
                <h1>HVI Continuity Platform</h1>
                <p>Welcome back, {user?.name || 'User'}!</p>
            </div>

            {/* Dashboard Stats */}
            {dashboardData && (
                <div className="dashboard-stats">
                    <div className="stat-card">
                        <h3>Total Assessments</h3>
                        <span className="stat-number">{dashboardData.totalAssessments}</span>
                    </div>
                    <div className="stat-card">
                        <h3>Completed</h3>
                        <span className="stat-number">{dashboardData.completedAssessments}</span>
                    </div>
                    <div className="stat-card">
                        <h3>Average Score</h3>
                        <span className="stat-number">{dashboardData.averageScore}%</span>
                    </div>
                </div>
            )}

            {/* Actions Section */}
            <div className="dashboard-actions">
                <button 
                    className="btn-primary large"
                    onClick={handleCreateNewAssessment}
                >
                    Create New Assessment
                </button>
            </div>

            {/* Recent Assessments */}
            <div className="recent-assessments">
                <h2>Recent Assessments</h2>
                {assessments.length === 0 ? (
                    <div className="no-assessments">
                        <p>No assessments yet. Create your first assessment to get started!</p>
                    </div>
                ) : (
                    <div className="assessments-grid">
                        {assessments.slice(0, 6).map(assessment => (
                            <div key={assessment._id} className="assessment-card">
                                <h3>{assessment.title}</h3>
                                <p>{assessment.description}</p>
                                <div className="assessment-meta">
                                    <span className="department">{assessment.department}</span>
                                    <span className={\status \\}>
                                        {assessment.status || 'Draft'}
                                    </span>
                                </div>
                                <div className="assessment-actions">
                                    <button 
                                        className="btn-secondary"
                                        onClick={() => handleTakeAssessment(assessment._id)}
                                    >
                                        Take Assessment
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>

            {/* Quick Links */}
            <div className="quick-links">
                <h2>Quick Access</h2>
                <div className="links-grid">
                    <div className="link-card">
                        <h3>Assessment Library</h3>
                        <p>Browse all available assessments</p>
                    </div>
                    <div className="link-card">
                        <h3>Progress Reports</h3>
                        <p>View detailed progress analytics</p>
                    </div>
                    <div className="link-card">
                        <h3>Team Management</h3>
                        <p>Manage team members and permissions</p>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default Dashboard;
